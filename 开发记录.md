# 2024/6

## day 27

- 新建项目
- 搭建了界面基本结构（Layout组件）
- main中配置了标题栏样式
- renderer中设置了标题栏的可拖拽部分

# 2024/7

## day 3

- 实现了主题切换（基于CSS变量）
  - 在全局样式文件中添加两个类（`dark-theme`和 `light-theme`），当中存放同名不同值的css变量
  - 在body标签上添加 `light-theme`类作为默认样式
  - 切换时，只需要通过 `document.body.classList.toggle('dark-theme')`便可以切换样式（body同时有dark和light两个类时，后添加的dark类中重复的样式会覆盖light中的）

## day 8

- 实现动态修改标题栏样式

  - 添加 `changeTitleBar`事件，在切换主题时触发，修改标题栏的颜色
- 添加 `vue-router`
- 添加了登录窗口，实现了窗口间切换

  - 添加 `openNewWindow`事件，在登录成功后触发，打开主界面并关闭登录窗口
  - 添加 `createWindow`方法的参数，可动态设置窗口的属性
  - 通过参数中的 `route`属性可以设置窗口打开时的路由
- 添加自定表单组件 `FBtn`。

  - 引入时报错 `[Vue warn]: Property "Login" was accessed during render but is not defined on instance.`报错行为 `Login`页面中使用 `FBtn`组件的那行。报错原因是 `FBtn`的 `label`属性误加了冒号

## day 9

- 编写登录窗口样式

  <img src="./file/img/image-20240709104341749.png" alt="image-20240709104341749" style="zoom: 50%;" />
- 引入自定输入框组件

  - 通过 `v-model`实现了数据的双向绑定，动态传入输入框的 `label`、双向绑定 `value`、`type`属性
- 实现登录与注册窗口的动态切换

  <img src="./file/img/image-20240709164020892.png" alt="image-20240709164020892" style="zoom:50%;" />
- 添加注册用邮箱验证码检测窗口

  - 在主进程中添加新函数 `createModalWin`函数用于创建模态窗口，需要指定父窗口，模态窗口显示时不能操作父窗口

  <img src="./file/img/image-20240709203759960.png" alt="image-20240709203759960" style="zoom:50%;" />

## day 10

- 完善注册界面

  <img src="./file/img/image-20240710105939579.png" alt="image-20240710105939579" style="zoom:50%;" />

## day 19

- 使用pixso工具对主界面进行初步设计

![image-20240719204236110](./file/img/image-20240719204236110.png)

## day 20

- 之前的界面感觉不太合理。重新设计了主界面结构

![image-20240720210523568](./file/img/image-20240720210523568.png)

## day 21

- 实现了拖拽边框动态设置边栏宽度的功能

## day 22

- 编写左边栏的样式
- 使用apifox工具中的Mock接口来模拟获取后端数据
- 引入了axios用于发送请求。进行了简单封装
- 在vite配置文件中通过代理服务器的方式解决了跨域问题
- 新建了SearchInput组件和Icon组件。Icon组件将存放所有的图标，通过传入name属性来显示对应的图标

![image-20240722210709036](./file/img/image-20240722210709036.png)

## day 23

- 继续完善左边栏样式
- 新增了Avatar组件用来显示头像，传入url、size、shape三个属性来自定图片内容、大小和形状（圆形和方形）
- 编写了完善的日期处理工具

  - 可以将传入时间转换成如下显示格式：

    1. 当天的时间显示格式：`时:分 时段`，采用12小时制，且时数不需额外补零
    2. 昨天的时间显示：`昨天`
    3. 本周内的时间显示：`周n`
    4. 更早的时间显示：`年/月/日`
- 实现了列表中名称和消息处的单行文本显示，超出文本显示为省略号

  ```css
  text-overflow: ellipsis;
  overflow: hidden;
  white-space: nowrap;
  ```
- 完善了左边栏拖动限制和窗口min-width、min-height的限制
- 拖动边框放大窗口时边框处会有黑条出现。不过同样用electron编写的vscode也存在这种情况我就放心了

![image-20240723192342681](./file/img/image-20240723192342681.png)

## day 24

- 修改了左边栏滚动条的样式
  - 实现了悬浮时显示滚动条，移出时隐藏滚动条
  - 滚动条出现时不会挤压左侧内容产生偏移
  - 滚动条不在顶端时添加边界线
- 新增了右侧页面结构对应的路由
- 实现了点击左侧聊天列表跳转至对应的路由
  - 通过代理事件进行了优化，只需绑定一个点击事件

![image-20240724202159340](./file/img/image-20240724202159340.png)

## day 25

- 完善右侧聊天框样式
- 优化Icon组件显示逻辑
  - 通过Map记录图标，key为图标name，value为svg字符串，通过v-html传入svg字符串的方式渲染props中的name属性指定的图标
- 实现自定义窗口栏按钮，通过在main中监听窗口最大化和恢复事件来通知renderer，以更换第二个图标
- 完善左侧聊天列表的active显示
  - 初始化时或点击聊天项时，获取active的项并添加对应样式

![image-20240725205015940](./file/img/image-20240725205015940.png)

## day 26

- 后续内容技术栈确定。后端使用node.js+express框架，数据库使用MongoDB，使用websocket实现即时通信
- 完善右侧聊天界面样式

  - 新建ChatMsg组件，用于显示单条聊天记录
  - 实现了文本超过50%行宽自动换行
  - 使用border的特性绘制了对话框底部的三角形箭头
  - 添加了录制音频的动画

![image-20240726230932524](./file/img/image-20240726230932524.png)

## day 28

- 搭建了项目中后端的基本框架
- 创建了config文件用于存放静态配置参数，如端口号、数据库名、当前ip和协议等

## day 29

- 新增了用户注册接口
- 使用jwt解决身份验证问题，新建了jwt校验中间件。使用if判断排除了不需要通过校验的路径和方法
- 使用MongoDB搭建了数据库
  - 新增了四种文档模型
    - User：存储用户信息
    - Group：存储群聊组信息
    - Message：存储聊天记录信息
    - Friendship：存储好友关系信息

## day 30

- 后端

  - 新增了全局异常处理中间件
  - 使用express-validator对请求参数进行校验，封装了参数校验util函数
  - UserRouter新增了用户登录、获取用户好友列表接口
  - MessageRouter新增新建消息、获取好友间的聊天记录接口
  - FriendshipRouter新增添加好友申请、更新好友申请接口
  - 新增了图片路径修正util函数，用于将保存在用户模型中的avatar属性的路径补充完整
- 前端

  - 登录、获取聊天记录、获取好友列表等Mock数据改为真实数据动态获取
  - 解决了在前端图片因Content Security Policy策略而无法显示的问题

![image-20240730212320462](./file/img/image-20240730212320462.png)

## day 31

- 使用socket.io库建立了socket连接，用于聊天的实时通信
  - 实现了聊天消息的实时发送，服务端接收到前端发送的消息后，保存该消息并将消息推送给当前用户和目标用户的客户端
- 新增了services，将router中涉及数据库的操作都抽离出来放置在了service中
- 实现了载入chat组件或发送消息后就将消息区的滚动条滚动至最下方
  - 实现起来稍显麻烦。在vue中，本可以直接通过ref获取节点，然后令其scrollTop = scrollHeight即可让滚动条移动至低端，但由于该滚动条的容器这个节点中包含了需要发送请求动态获取的数据，所以使用常规的onMounted + nextTick不会生效，只能通过setTimeout来实现，但会有明显卡顿感，用户体验不佳
  - 我采用了通过watch监听页面中的messages变量变化时进行滚动条scroll属性的设置，此时页面中的变量已成功获取，滚动条属性的设置也可以正常生效

# 2024/8

## day 1

- 把socket连接移动到了layout组件中
- 解决了头像显示的小错误
- 现在输入框可以进行换行了
  - 将input替换成了textarea。为实现换行后自动调整高度，对newMsg值进行了监听，变动时将textarea的height值设置成scrollHeight值高度即可自动撑开容器。
  - 遇到的问题是不管怎么修改lineHeight，文本只有一行时却总是占据两行的高度，两行三行时高度都是正常的。最后发现textarea默认高度是line-height的两倍，即rows属性为2。设置成1就没问题了
  - 换行后的消息显示上，换行符都变成了空格。后通过添加属性white-space: pre-wrap;解决了这个问题
  - 也遇到了一大串字母没有自动换行的情况。设置overflow-wrap: anywhere;后被视为一整个单词的文本也可以自动换行了
- 实现了客户端登录后修改用户状态为online，并通知在线的好友。断线时同样会修改状态和通知
- 消息记录中现在会显示时间。每天的首条消息以及之后每隔一小时以上的消息上方都会显示对应的时间

![image-20240801205419123](./file/img/image-20240801205419123.png)

## day 2

- 修复了输入框按回车发送时高度跳动
  - 原因是enter默认事件会进行换行，解决方法是将keyup换成keydown，然后进行判断，如果enter的keydown事件中未按下shift，则阻止默认事件
- 修复了左侧列表的最后一条消息未与右侧聊天栏同步的情况。通过bus进行同步
- 编写了左侧弹出栏的样式

## day 3

- 完善左弹出栏样式

![image-20240803104406238](./file/img/image-20240803104406238.png)

- 实现对数据进行分页获取的接口。通过传入的pageSize和pageNum来计算limit和skip从而获取对应数据

## day 4

- 前端实现上划获取分页数据的功能
  - 编写了节流函数对上划进行了限制
  - 通过保存附加数据前第一个子元素的高度位置，然后在获取新的分页数据后调整滚动条的位置至保存的高度，以实现附加数据后内容不会跳动
  - 通过pinia和持久化存储来保存已获取的聊天记录

## day 7

- 修复了由于切换聊天用户，socket监听事件堆叠导致的问题
  - 在activated和deactivated生命周期中进行事件的绑定和解绑
- 重新设定了页码，在获取聊天记录同时获取总页数，然后在此基础上获取指定页码的分页记录
  - 从旧记录为大页码改为新记录大页码，防止添加新的消息时前面的消息页码变动

## day 8

- 采用了游标分页的方式来取代传统页码分页查询，这样既提高了查询效率又可以防止新增消息使页码错乱的情况发生

## day 9

- 完善向上滚动获取更多消息的显示效果
  - 使用scrollHeight和scrollTop来计算底部到当前位置的高度H，然后在获取完新的数据后将scrollTop设置为当前scrollHeight减去H即可
- 实现了消息缓存效果

## day 10

- 完善了左弹出栏的样式
- 将用户当前状态显示的部分抽离成了一个组件

![image-20240810210030221](./file/img/image-20240810210030221.png)

## day 11

- 修复了不同chat间接收消息时的混淆现象
- 将chatlist从aside组件中分离

## day 13

- 新增了右边栏，用于显示好友的详细信息并提供对好友的操作
  - 实现了点击右边栏以外的区域收回边栏，通过contain方法来判断点击事件对象的目标是否包含在目标节点之内。点击header组件中的按钮打开边栏，并同时给全局绑定上述点击事件。触发事件后解绑

![image-20240813223153692](./file/img/image-20240813223153692.png)

## day 15

- 完善了右边栏样式

![image-20240815210128356](./file/img/image-20240815210128356.png)

## day 16

- 添加Emoji组件，显示表情栏
- 实现表情栏窗口的弹出和关闭
  - 期间遇到ipcMain的事件重复绑定的问题，通过在关闭窗口中解绑对应事件解决

![image-20240817074352706](./file/img/image-20240817074352706.png)

## day 17

- 实现表情在输入框中的显示

  - 重构了输入框
    - 现在输入框基于可编辑的div元素实现
    - 将输入框分离出Chat组件，新建了InputArea组件
  - 实现了表情栏和输入栏的跨窗口通信
    - 现在点击表情栏中的表情可以在输入框中显示对应图片，然后实际消息增加表情对应的标识符（字符串类型，#[]格式）
  - 遇到的问题
    1. 起始使用v-html来显示输入框中的内容，在input事件中替换newMsg的值为事件对象的innerText，后发现每次输入指针都会自动跑到最前面，而且v-html存在xss攻击的隐患
    2. 关于newMsg和html，本打算一个变量存储实际html，一个来存储对应的实际消息，但难以实现它们复杂的转换，改为：点击表情获取id，在输入框中添加对应src和alt的img元素
    3. 关于拖拽和复制粘贴，对这些操作进行了一定程度的限制
    4. 将输入栏组件分离后的诸多问题：
       1. friend对象无法正常获取：原因是friend对象在chat组件中是异步获取的，所以在模板中把friend对象作为自定义参数传入InputArea组件是无法正常生效的，只能通过v-if限制InputArea组件的渲染，等friend获取之后再加载对应的输入框组件
       2. 在新组件中没有onActivated周期，所以ipcMain的表情获取的回调函数未能正确的传递
    5. 表情插入后输入框失焦以及浮标错位，通过selection、range等未接触过的类实现了在当前浮标处插入表情图片和重新聚焦等来解决。在文本之间插入表情也是通过这些来实现的
    6. 换行和空格被变成了br元素和$nbsp;通过正则和replace进行替换以解决
- 实现表情在消息栏中的显示

  - 现在消息栏中可以正常显示表情
    - 具体方法是通过识别#[]格式的字符串，然后替换为对应的img标签，再通过v-html来渲染
    - 后续改进：通过函数来识别#[]字符串并将原字符串拆分成文本和表情字符串集合的数组，然后通过v-for按顺序渲染这些文本和表情
    - 将msg-box由flex布局改为了普通的布局，因为渲染文本和图片在flex布局中会错位

![image-20240817211142055](./file/img/image-20240817211142055.png)

## day 18

- 添加了新的字体：SmileySans，国内开源免费的优质字体
- 后端新建了新的文档模型（已读回执），以及基本的查询和save方法
  - 打算通过建立已读回执的方式来进行已读未读的判断

## day 19

- 完成了消息界面已读未读的功能

> 我在博客上记录了这部分开发的详细思路：[FChat开发记录 - 消息已读管理-CSDN博客](https://blog.csdn.net/fafafafa_fa/article/details/141334394)

![image-20240819221931550](./file/img/image-20240819221931550.png)

## day 22

- 完善了README文档

## day 23

- 完成邮箱验证和注册功能
  - 通过nodemailer发送邮件，邮箱服务器使用的是qq邮箱
  - 使用crypto来生成随机验证码
  - 使用memory-cache来缓存对应的邮箱和验证码

## day 27

- 完成nav栏的切换功能
  - 使用一个对象来存储路由映射关系
  - 跳转路由时发现无法正常获取ChatList组件中的avtiveItem，原因是在setup阶段获取到的route信息是错误的。通过设置setTimeout(()=>{}, 0)的方式解决
  - 跳转后记录当前路由，等再回到这个nav时会自动恢复路由
- 简单编写了好友列表界面

![image-20240827213641995](.\file\img\image-20240827213641995.png)

- 从引入新字体之后控制台一直报错：

`[Intervention] Slow network is detected. See https://www.chromestatus.com/feature/5636954674692096 for more details. Fallback font will be used while loading: http://localhost:5173/@fs/C:/Users/Young/Desktop/chat/front-end/public/fonts/SmileySans-Oblique.otf.woff2`

- 通过在html中加入字体预加载解决了该问题

```html
<link rel="preload" href="/path/to/your/font.woff2" as="font" type="font/woff2" crossorigin="anonymous">
```

## day 28

- 编写了申请列表的样式
- 后端编写了查询好友列表和查询申请消息等接口
- 添加了接收到消息后的提示音

![image-20240828205442988](.\file\img\image-20240828205442988.png)

## day 29

- 修复打包后黑屏的问题
- 后端添加cors解决跨域问题，不再使用前端proxy代理解决
- 解决了electron-builder打包后前端静态资源无法获取的问题

## day 31

- 后端新增统一返回类Result，统一了返回的格式，并提供了success和error两个便捷的方法来调用
- 重写了electron的主进程代码，将冗余的代码进行了合并和清除
- 修复了前端时间格式化工具的错误（是否是本周的判断中出现了错误）
- 简单编写了添加好友的界面

![image-20240831234110312](.\file\img\image-20240831234110312.png)

# 2024/9

## day 1

- 后端编写了根据关键词模糊查询用户的接口
- 继续编写添加好友的界面，添加了一些动画效果

## day 2

- 完善查找界面样式
- 完善了搜索框组件的内容
- 对输入框搜索的函数进行了防抖处理
- 解决了chat组件中切换对话后bus事件无法触发的问题
  - 原因是未在reactive生命周期中重新绑定事件

![image-20240902123608012](.\file\img\image-20240902123608012.png)

## day 4

- 重写了主进程代码
  - 重写了关于表情id的ipc事件的绑定，现在不需要重复地绑定与解绑
  - 增加了新建窗口的配置项，现在可以创建在任务栏中显示的窗口
  - 实现窗口自定义标题名
- 优化了有关标题栏的代码
  - 取消所有默认标题栏，改为自定义标题栏
  - 将Titlebar组件进行完善，通过传入参数控制显示哪些按钮以及调整一些样式

## day 6

- 编写了申请好友界面的样式
- 修复了输入框中频繁出现红色波浪线提示的问题
  - 在input元素中添加 `spellcheck="false"`即可
- 修复了多处文本溢出的错误
- 完善了添加好友的接口
- 实现了申请列表中接受请求的功能

![image-20240906153008526](file\img\image-20240906153008526.png)

## day 8

- 编写了朋友详细界面的样式
- 在Nav组件中新增了便捷的跳转方法

![image-20240908215336488](file\img\image-20240908215336488.png)

## day 9

- 实现了本地音频录制的功能
- 仿照telegram重写了nav栏的样式
  - 使用Teleport和Transition标签实现了遮罩层的显示

![image-20240909205808856](file\img\image-20240909205808856.png)



## day 10

- 完善了nav栏的样式，添加了switch按钮并实现了切换主题的功能
- 实现了音频在本地的录制与上传服务器的功能
- 编写了音频消息在聊天界面中的显示样式
- 自定义了播放控件样式与功能

![image-20240910171048177](file\img\image-20240910171048177.png)

![image-20240910215023758](file\img\image-20240910215023758.png)



## day 11

- 通过在音频消息`loadedmetadata`事件上添加`.once`修饰符修复了发送新消息后音频消息闪动的问题、
- 将使用Teleport编写的边栏遮罩抽象为组件Mask。重写了右边栏（好友详细信息）的样式
- 在聊天界面的上方显示好友最后查看消息的时间。使用了一套新的时间格式化函数来进行时间的显示
- 修复了socket中read事件发送给错误用户的问题。现在事件名与目标用户id相关



## day 13 

- 完善了右边栏的样式

- 修改了聊天界面的字体相关样式
- 优化了各个列表中item的悬浮效果
- 解决了切换主题时部分文本和背景颜色切换延迟问题



![image-20240913214748954](file\img\image-20240913214748954.png)
